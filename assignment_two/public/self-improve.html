<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Improvement - Debt Collection Testing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-robot text-blue-600 mr-2"></i>
                    Debt Collection Testing Platform
                </h1>
                <div class="flex space-x-6">
                    <a href="/" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-cog mr-1"></i> Main Agent
                    </a>
                    <a href="/test-agents" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-users mr-1"></i> Test Agents
                    </a>
                    <a href="/simulate" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-comments mr-1"></i> Simulate
                    </a>
                    <a href="/self-improve" class="text-blue-600 font-medium border-b-2 border-blue-600 pb-1">
                        <i class="fas fa-brain mr-1"></i> Self-Improve
                    </a>
                    <a href="/history" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-history mr-1"></i> History
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Header Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">ðŸ§  AI Self-Improvement System</h2>
            <p class="text-gray-600">Automatically improve your debt collection agent by testing against specific customer personalities and iteratively optimizing the prompt until peak performance is achieved.</p>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Current Best Agent Section -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 mb-8 border-l-4 border-green-500">
            <div class="flex items-center mb-4">
                <i class="fas fa-trophy text-green-600 text-2xl mr-3"></i>
                <div>
                    <h3 class="text-xl font-bold text-green-900">Current Best Agent</h3>
                    <p class="text-green-700">Best performing prompt across all personalities</p>
                </div>
                <div class="ml-auto">
                    <div class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-lg">
                        <i class="fas fa-star mr-1"></i>
                        <span id="bestScore">--/10</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium text-gray-900">Current Prompt:</h4>
                    <button id="editBestPrompt" class="text-green-600 hover:text-green-700 text-sm">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                </div>
                <div id="bestPrompt" class="text-sm text-gray-700 font-mono bg-gray-50 p-3 rounded border max-h-32 overflow-y-auto">
                    Loading current agent prompt...
                </div>
            </div>
        </div>

        <!-- Main Control Panel -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-rocket text-purple-600 mr-2"></i>
                Start Self-Improvement Process
            </h3>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Personality Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-user-check text-blue-600 mr-1"></i>
                        Select Target Personality
                    </label>
                    <div id="personalityOptions" class="space-y-3">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Configuration -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-target text-orange-600 mr-1"></i>
                            Target Score
                        </label>
                        <input type="number" id="targetScore" min="1" max="10" step="0.1" value="8.5"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-repeat text-indigo-600 mr-1"></i>
                            Max Iterations
                        </label>
                        <input type="number" id="maxIterations" min="1" max="10" value="5"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <button id="startImprovement" 
                        class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium"
                        disabled>
                        <i class="fas fa-rocket mr-2"></i>
                        Start Self-Improvement
                    </button>
                </div>
            </div>
        </div>

        <!-- Live Progress Section -->
        <div id="progressSection" class="hidden bg-white rounded-lg shadow-sm border p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-cogs text-purple-600 mr-2"></i>
                    Self-Improvement in Progress
                </h3>
                <button id="stopImprovement" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-stop mr-1"></i>
                    Stop Process
                </button>
            </div>

            <!-- Current Status -->
            <div class="bg-blue-50 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-blue-900 font-medium">
                        <i class="fas fa-user mr-1"></i>
                        Improving Against: <span id="currentPersonality">--</span>
                    </span>
                    <span class="text-blue-700">
                        Iteration <span id="currentIteration">0</span>/<span id="maxIterationDisplay">5</span>
                    </span>
                </div>
                
                <div class="mb-3">
                    <div class="flex justify-between text-sm text-blue-700 mb-1">
                        <span>Progress</span>
                        <span><span id="currentScore">--</span>/10 (Target: <span id="targetScoreDisplay">8.5</span>)</span>
                    </div>
                    <div class="bg-blue-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div id="latestChange" class="text-sm text-blue-800 italic">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="changeDescription">Initializing self-improvement process...</span>
                </div>
            </div>

            <!-- Real-time Conversation Display -->
            <div id="liveConversation" class="hidden">
                <h4 class="font-medium text-gray-900 mb-2">
                    <i class="fas fa-comments text-green-600 mr-1"></i>
                    Live Conversation Test
                </h4>
                <div id="miniChatDisplay" class="bg-gray-50 rounded-lg p-3 h-40 overflow-y-auto text-sm border">
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                        <p>Running conversation test...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evolution Visualization -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Performance Chart -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-line text-green-600 mr-2"></i>
                    Performance Evolution
                </h3>
                <div class="h-64">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div id="chartLegend" class="mt-4 text-sm text-gray-600">
                    Select a personality and start improvement to see progress
                </div>
            </div>

            <!-- Iteration History -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-history text-orange-600 mr-2"></i>
                    Iteration History
                </h3>
                <div id="iterationHistory" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <p>No improvement sessions yet</p>
                        <p class="text-sm">Start a self-improvement process to see iteration history</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Evolution Comparison -->
        <div id="promptComparison" class="hidden mt-8 bg-white rounded-lg shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-code-branch text-purple-600 mr-2"></i>
                Prompt Evolution Comparison
            </h3>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">
                        Original Prompt (Iteration 1)
                    </h4>
                    <div id="originalPrompt" class="bg-red-50 border border-red-200 rounded-lg p-4 font-mono text-sm max-h-40 overflow-y-auto">
                        --
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">
                        Current Best (Latest Iteration)
                    </h4>
                    <div id="improvedPrompt" class="bg-green-50 border border-green-200 rounded-lg p-4 font-mono text-sm max-h-40 overflow-y-auto">
                        --
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-center">
                <button id="applyBestPrompt" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-check mr-1"></i>
                    Apply Best Prompt as Main Agent
                </button>
            </div>
        </div>
    </div>

    <script>
        let testAgents = [];
        let selectedPersonality = null;
        let improvementInProgress = false;
        let currentSession = null;
        let performanceChart = null;

        // Initialize page
        async function initializePage() {
            await loadTestAgents();
            await loadCurrentBestAgent();
            initializeChart();
        }

        // Load test agents for personality selection
        async function loadTestAgents() {
            try {
                const response = await fetch('/api/test-agents');
                testAgents = await response.json();
                renderPersonalityOptions();
            } catch (error) {
                showStatus('Error loading test agents', 'error');
            }
        }

        // Load current best agent
        async function loadCurrentBestAgent() {
            try {
                const response = await fetch('/api/main-agent');
                const agent = await response.json();
                if (agent) {
                    document.getElementById('bestPrompt').textContent = agent.prompt || 'No prompt available';
                    // TODO: Load best score from improvement history
                    document.getElementById('bestScore').textContent = '7.2/10';
                }
            } catch (error) {
                showStatus('Error loading current agent', 'error');
            }
        }

        // Render personality options
        function renderPersonalityOptions() {
            const container = document.getElementById('personalityOptions');
            if (testAgents.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No test agents available. <a href="/test-agents" class="text-blue-600 hover:underline">Create some first</a>.</p>';
                return;
            }

            container.innerHTML = testAgents.map(agent => `
                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors personality-option" data-agent-id="${agent.id}">
                    <input type="radio" name="personality" value="${agent.id}" class="mr-3">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-900 mr-2">${agent.name}</span>
                            <span class="px-2 py-1 rounded text-xs ${getTypeColor(agent.type)}">${agent.type}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${agent.background.substring(0, 100)}...</p>
                    </div>
                </label>
            `).join('');

            // Add event listeners
            document.querySelectorAll('input[name="personality"]').forEach(radio => {
                radio.addEventListener('change', handlePersonalitySelection);
            });
        }

        // Handle personality selection
        async function handlePersonalitySelection(e) {
            const agentId = parseInt(e.target.value);
            selectedPersonality = testAgents.find(agent => agent.id === agentId);
            document.getElementById('startImprovement').disabled = false;
            
            // Highlight selected option
            document.querySelectorAll('.personality-option').forEach(option => {
                option.classList.remove('bg-purple-50', 'border-purple-300');
            });
            e.target.closest('.personality-option').classList.add('bg-purple-50', 'border-purple-300');
            
            // Load historical sessions for this personality
            await loadHistoricalSessions(agentId);
        }

        // Load historical sessions for selected personality
        async function loadHistoricalSessions(agentId) {
            try {
                const response = await fetch(`/api/self-improve/history/${agentId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayHistoricalSessions(result.sessions);
                } else {
                    console.error('Error loading historical sessions:', result.error);
                    displayHistoricalSessions([]);
                }
            } catch (error) {
                console.error('Error fetching historical sessions:', error);
                displayHistoricalSessions([]);
            }
        }

        // Display historical sessions in the UI
        function displayHistoricalSessions(sessions) {
            const container = document.getElementById('iterationHistory');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p>No improvement sessions yet</p>
                        <p class="text-sm">Start a self-improvement process to see iteration history</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    ${sessions.map(session => {
                        const scoreColor = session.bestScore >= 8 ? 'text-green-600' : 
                                         session.bestScore >= 6 ? 'text-yellow-600' : 'text-red-600';
                        const statusColor = session.success ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
                        
                        return `
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <span class="font-medium text-gray-900">Session ${session.id}</span>
                                        <span class="ml-2 px-2 py-1 ${statusColor} text-xs rounded-full">
                                            ${session.success ? `âœ“ Target Reached (${session.bestScore.toFixed(1)}/10)` : `${session.iterationHistory.length}/${session.maxIterations} iterations`}
                                        </span>
                                    </div>
                                    <span class="text-xs text-gray-500">
                                        ${new Date(session.startTime).toLocaleDateString()} ${new Date(session.startTime).toLocaleTimeString()}
                                    </span>
                                </div>
                                
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm text-gray-600">Best Score:</span>
                                    <span class="font-bold ${scoreColor}">${session.bestScore.toFixed(1)}/10</span>
                                </div>
                                
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600">Iterations:</span>
                                        <div class="flex space-x-1">
                                            ${session.iterationHistory.map((iteration, index) => {
                                                const iterScoreColor = iteration.score >= 8 ? 'bg-green-500' : 
                                                                       iteration.score >= 6 ? 'bg-yellow-500' : 'bg-red-500';
                                                return `<div class="w-6 h-6 ${iterScoreColor} rounded text-white text-xs flex items-center justify-center" title="Iteration ${index + 1}: ${iteration.score.toFixed(1)}/10">${index + 1}</div>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    <button class="w-full text-left p-2 bg-gray-50 rounded text-sm hover:bg-gray-100 transition-colors" 
                                            onclick="toggleSessionDetails('${session.id}')">
                                        <i class="fas fa-chevron-down mr-1"></i> View Iteration Details
                                    </button>
                                    
                                    <div id="details-${session.id}" class="hidden mt-2 space-y-2">
                                        ${session.iterationHistory.map((iteration, index) => {
                                            const iterScoreColor = iteration.score >= 8 ? 'text-green-600' : 
                                                                   iteration.score >= 6 ? 'text-yellow-600' : 'text-red-600';
                                            return `
                                                <div class="border-l-2 border-gray-200 pl-3 py-2">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <span class="font-medium text-sm">Iteration ${iteration.iteration}</span>
                                                        <span class="font-bold ${iterScoreColor}">${iteration.score.toFixed(1)}/10</span>
                                                    </div>
                                                    ${iteration.analysis && iteration.analysis.strengths ? `
                                                        <div class="text-xs text-gray-600 mb-1">
                                                            <strong>Strengths:</strong> ${iteration.analysis.strengths.slice(0, 2).join(', ')}
                                                        </div>
                                                    ` : ''}
                                                    ${iteration.analysis && iteration.analysis.improvements ? `
                                                        <div class="text-xs text-gray-600">
                                                            <strong>Improvements:</strong> ${iteration.analysis.improvements.slice(0, 2).join(', ')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                        
                                        <div class="mt-3 p-2 bg-blue-50 rounded text-xs">
                                            <strong>Best Prompt:</strong> ${session.bestPrompt.substring(0, 200)}...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Toggle session details display
        function toggleSessionDetails(sessionId) {
            const details = document.getElementById(`details-${sessionId}`);
            const button = details.previousElementSibling;
            const icon = button.querySelector('i');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                details.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        // Get type color styling
        function getTypeColor(type) {
            switch (type) {
                case 'Cooperative': return 'bg-green-100 text-green-800';
                case 'Neutral': return 'bg-yellow-100 text-yellow-800';
                case 'Hostile': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Start self-improvement process
        async function startSelfImprovement() {
            if (!selectedPersonality) {
                showStatus('Please select a personality first', 'error');
                return;
            }

            const targetScore = parseFloat(document.getElementById('targetScore').value);
            const maxIterations = parseInt(document.getElementById('maxIterations').value);

            if (targetScore < 1 || targetScore > 10) {
                showStatus('Target score must be between 1 and 10', 'error');
                return;
            }

            improvementInProgress = true;
            showProgressSection();
            
            // Update UI
            document.getElementById('currentPersonality').textContent = selectedPersonality.name;
            document.getElementById('maxIterationDisplay').textContent = maxIterations;
            document.getElementById('targetScoreDisplay').textContent = targetScore;
            document.getElementById('startImprovement').disabled = true;

            try {
                // Start improvement process
                const response = await fetch('/api/self-improve/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        personalityId: selectedPersonality.id,
                        targetScore: targetScore,
                        maxIterations: maxIterations
                    })
                });

                const result = await response.json();
                if (result.success) {
                    currentSession = result.sessionId;
                    monitorImprovement();
                    showStatus('Self-improvement process started successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to start improvement process');
                }
            } catch (error) {
                showStatus('Error starting improvement: ' + error.message, 'error');
                resetProgressSection();
            }
        }

        // Monitor improvement progress
        async function monitorImprovement() {
            if (!currentSession || !improvementInProgress) return;

            try {
                const response = await fetch(`/api/self-improve/status/${currentSession}`);
                const status = await response.json();

                updateProgressDisplay(status);

                if (status.completed) {
                    improvementCompleted(status);
                } else {
                    // Continue monitoring
                    setTimeout(monitorImprovement, 2000);
                }
            } catch (error) {
                showStatus('Error monitoring progress: ' + error.message, 'error');
                resetProgressSection();
            }
        }

        // Update progress display
        function updateProgressDisplay(status) {
            document.getElementById('currentIteration').textContent = status.currentIteration || 0;
            document.getElementById('currentScore').textContent = (status.currentScore || 0).toFixed(1);
            
            const progress = ((status.currentIteration || 0) / (status.maxIterations || 5)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            if (status.latestChange) {
                document.getElementById('changeDescription').textContent = status.latestChange;
            }

            // Update chart if we have iteration data
            if (status.iterationHistory && status.iterationHistory.length > 0) {
                updatePerformanceChart(status.iterationHistory);
                updateIterationHistory(status.iterationHistory);
            }
        }

        // Handle improvement completion
        function improvementCompleted(status) {
            improvementInProgress = false;
            document.getElementById('stopImprovement').textContent = 'Process Complete';
            document.getElementById('stopImprovement').disabled = true;
            document.getElementById('stopImprovement').classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('stopImprovement').classList.add('bg-green-600');

            if (status.success) {
                showStatus(`Self-improvement completed! Final score: ${status.finalScore.toFixed(1)}/10`, 'success');
                
                // Show prompt comparison
                if (status.originalPrompt && status.bestPrompt) {
                    showPromptComparison(status.originalPrompt, status.bestPrompt);
                }
                
                // Update best agent if score improved
                if (status.finalScore > 7.2) { // Current best score placeholder
                    document.getElementById('bestScore').textContent = `${status.finalScore.toFixed(1)}/10`;
                    document.getElementById('bestPrompt').textContent = status.bestPrompt;
                }
            } else {
                showStatus('Self-improvement completed without reaching target score', 'warning');
            }

            document.getElementById('startImprovement').disabled = false;
        }

        // Show progress section
        function showProgressSection() {
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('liveConversation').classList.remove('hidden');
        }

        // Reset progress section
        function resetProgressSection() {
            improvementInProgress = false;
            currentSession = null;
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('startImprovement').disabled = false;
        }

        // Stop improvement process
        async function stopImprovement() {
            if (!currentSession) return;

            try {
                await fetch('/api/self-improve/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: currentSession })
                });
                
                resetProgressSection();
                showStatus('Self-improvement process stopped', 'info');
            } catch (error) {
                showStatus('Error stopping process: ' + error.message, 'error');
            }
        }

        // Initialize performance chart
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Performance Score',
                        data: [],
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Score (1-10)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Iteration'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update performance chart
        function updatePerformanceChart(iterationHistory) {
            const labels = iterationHistory.map((_, index) => `Iteration ${index + 1}`);
            const scores = iterationHistory.map(iteration => iteration.score);

            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = scores;
            performanceChart.update();
        }

        // Update iteration history display
        function updateIterationHistory(iterationHistory) {
            const container = document.getElementById('iterationHistory');
            
            if (iterationHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <p>No iterations yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = iterationHistory.map((iteration, index) => {
                const isLatest = index === iterationHistory.length - 1;
                const scoreColor = iteration.score >= 8 ? 'text-green-600' : iteration.score >= 6 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg ${isLatest ? 'border-2 border-purple-200' : ''}">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-700">Iteration ${index + 1}</span>
                            ${isLatest ? '<span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Latest</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold ${scoreColor}">${iteration.score.toFixed(1)}/10</span>
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: ${(iteration.score / 10) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show prompt comparison
        function showPromptComparison(originalPrompt, improvedPrompt) {
            document.getElementById('promptComparison').classList.remove('hidden');
            document.getElementById('originalPrompt').textContent = originalPrompt;
            document.getElementById('improvedPrompt').textContent = improvedPrompt;
        }

        // Apply best prompt as main agent
        async function applyBestPrompt() {
            const bestPrompt = document.getElementById('improvedPrompt').textContent;
            if (!bestPrompt || bestPrompt === '--') {
                showStatus('No improved prompt available', 'error');
                return;
            }

            try {
                const response = await fetch('/api/main-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Sarah - Self-Improved Debt Collection Agent',
                        prompt: bestPrompt
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showStatus('Best prompt applied as main agent successfully!', 'success');
                    document.getElementById('bestPrompt').textContent = bestPrompt;
                } else {
                    showStatus('Error applying prompt', 'error');
                }
            } catch (error) {
                showStatus('Error applying prompt: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                type === 'info' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
                'bg-red-100 text-red-800 border border-red-200'}`;
            statusEl.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 
                type === 'warning' ? 'fa-exclamation-triangle' :
                type === 'info' ? 'fa-info-circle' : 'fa-exclamation-circle'} mr-2"></i>${message}`;
            statusEl.classList.remove('hidden');

            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        // Event listeners
        document.getElementById('startImprovement').addEventListener('click', startSelfImprovement);
        document.getElementById('stopImprovement').addEventListener('click', stopImprovement);
        document.getElementById('applyBestPrompt').addEventListener('click', applyBestPrompt);

        // Initialize page on load
        initializePage();
    </script>
</body>

</html>