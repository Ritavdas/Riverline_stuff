<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Agents - Debt Collection Testing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-robot text-blue-600 mr-2"></i>
                    Debt Collection Testing Platform
                </h1>
                <div class="flex space-x-6">
                    <a href="/" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-cog mr-1"></i> Main Agent
                    </a>
                    <a href="/test-agents" class="text-blue-600 font-medium border-b-2 border-blue-600 pb-1">
                        <i class="fas fa-users mr-1"></i> Test Agents
                    </a>
                    <a href="/simulate" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-comments mr-1"></i> Simulate
                    </a>
                    <a href="/history" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-history mr-1"></i> History
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-6 py-8">
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Test Agent Personalities</h2>
                <p class="text-gray-600">Manage loan defaulter personalities to test your debt collection agent against various customer scenarios.</p>
            </div>
            <button id="addAgentBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Add New Agent
            </button>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Test Agents Grid -->
        <div id="agentsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Agents will be loaded here -->
        </div>
    </div>

    <!-- Add/Edit Agent Modal -->
    <div id="agentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900">Add New Test Agent</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="agentForm">
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user text-blue-600 mr-1"></i> Name
                            </label>
                            <input 
                                type="text" 
                                name="name" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., Maria Rodriguez"
                                required
                            >
                        </div>

                        <!-- Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-tag text-blue-600 mr-1"></i> Cooperation Type
                            </label>
                            <select 
                                name="type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">Select Type</option>
                                <option value="Cooperative">Cooperative</option>
                                <option value="Neutral">Neutral</option>
                                <option value="Hostile">Hostile</option>
                            </select>
                        </div>

                        <!-- Communication Style -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comments text-blue-600 mr-1"></i> Communication Style
                            </label>
                            <input 
                                type="text" 
                                name="communication_style" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., Polite but defensive"
                                required
                            >
                        </div>

                        <!-- Background -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-info-circle text-blue-600 mr-1"></i> Background
                            </label>
                            <textarea 
                                name="background" 
                                rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Brief background about this person's situation"
                                required
                            ></textarea>
                        </div>

                        <!-- Financial Situation -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-dollar-sign text-blue-600 mr-1"></i> Financial Situation
                            </label>
                            <textarea 
                                name="financial_situation" 
                                rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Current financial circumstances"
                                required
                            ></textarea>
                        </div>

                        <!-- Cooperation Level -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-handshake text-blue-600 mr-1"></i> Cooperation Level Description
                            </label>
                            <input 
                                type="text" 
                                name="cooperation_level" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., High - wants to resolve debt but needs assistance"
                                required
                            >
                        </div>

                        <!-- Personality Traits -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-brain text-blue-600 mr-1"></i> Personality Traits (comma separated)
                            </label>
                            <input 
                                type="text" 
                                name="personality_traits" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="e.g., Honest, Stressed, Responsible, Family-oriented"
                                required
                            >
                        </div>

                        <!-- Likely Responses -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-quote-left text-blue-600 mr-1"></i> Likely Responses (one per line)
                            </label>
                            <textarea 
                                name="likely_responses" 
                                rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="I know I owe the money and I want to pay&#10;I lost my job recently, but I'm looking for work&#10;Can we set up a payment plan?&#10;I'm sorry, I've been struggling financially"
                                required
                            ></textarea>
                        </div>
                    </div>

                    <!-- Modal Actions -->
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-1"></i>
                            Save Agent
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let testAgents = [];
        let editingAgent = null;

        // Load test agents
        async function loadTestAgents() {
            try {
                const response = await fetch('/api/test-agents');
                testAgents = await response.json();
                renderAgents();
            } catch (error) {
                showStatus('Error loading test agents', 'error');
            }
        }

        // Render agents grid
        function renderAgents() {
            const grid = document.getElementById('agentsGrid');
            
            if (testAgents.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No test agents yet</h3>
                        <p class="text-gray-500 mb-4">Create your first test agent to start testing conversations</p>
                        <button onclick="openAddModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add Your First Agent
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = testAgents.map(agent => `
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${agent.name}</h3>
                            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${getTypeColor(agent.type)}">
                                ${agent.type}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editAgent(${agent.id})" class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAgent(${agent.id})" class="text-red-600 hover:text-red-800 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-gray-600 font-medium">Background:</p>
                            <p class="text-gray-800">${agent.background}</p>
                        </div>
                        
                        <div>
                            <p class="text-gray-600 font-medium">Communication Style:</p>
                            <p class="text-gray-800">${agent.communication_style}</p>
                        </div>
                        
                        <div>
                            <p class="text-gray-600 font-medium">Traits:</p>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${agent.personality_traits.slice(0, 3).map(trait => 
                                    `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${trait}</span>`
                                ).join('')}
                                ${agent.personality_traits.length > 3 ? `<span class="text-xs text-gray-500">+${agent.personality_traits.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <a href="/simulate?agent=${agent.id}" class="w-full inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-play mr-2"></i>
                            Test Against This Agent
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Get color class for agent type
        function getTypeColor(type) {
            switch(type) {
                case 'Cooperative': return 'bg-green-100 text-green-800';
                case 'Neutral': return 'bg-yellow-100 text-yellow-800';
                case 'Hostile': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Open add agent modal
        function openAddModal() {
            editingAgent = null;
            document.getElementById('modalTitle').textContent = 'Add New Test Agent';
            document.getElementById('agentForm').reset();
            document.getElementById('agentModal').classList.remove('hidden');
            document.getElementById('agentModal').classList.add('flex');
        }

        // Edit agent
        function editAgent(id) {
            editingAgent = testAgents.find(agent => agent.id === id);
            if (!editingAgent) return;

            document.getElementById('modalTitle').textContent = 'Edit Test Agent';
            
            // Fill form with agent data
            const form = document.getElementById('agentForm');
            Object.keys(editingAgent).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    if (key === 'personality_traits') {
                        input.value = editingAgent[key].join(', ');
                    } else if (key === 'likely_responses') {
                        input.value = editingAgent[key].join('\n');
                    } else {
                        input.value = editingAgent[key];
                    }
                }
            });

            document.getElementById('agentModal').classList.remove('hidden');
            document.getElementById('agentModal').classList.add('flex');
        }

        // Delete agent
        async function deleteAgent(id) {
            const agent = testAgents.find(a => a.id === id);
            if (!agent) return;

            if (!confirm(`Are you sure you want to delete "${agent.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/test-agents/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showStatus('Agent deleted successfully!', 'success');
                    await loadTestAgents();
                } else {
                    showStatus('Error deleting agent', 'error');
                }
            } catch (error) {
                showStatus('Error deleting agent', 'error');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('agentModal').classList.add('hidden');
            document.getElementById('agentModal').classList.remove('flex');
            editingAgent = null;
        }

        // Save agent
        async function saveAgent(formData) {
            try {
                // Convert form data to agent object
                const agentData = {};
                for (let [key, value] of formData.entries()) {
                    if (key === 'personality_traits') {
                        agentData[key] = value.split(',').map(t => t.trim()).filter(t => t);
                    } else if (key === 'likely_responses') {
                        agentData[key] = value.split('\n').map(r => r.trim()).filter(r => r);
                    } else {
                        agentData[key] = value;
                    }
                }

                const url = editingAgent ? `/api/test-agents/${editingAgent.id}` : '/api/test-agents';
                const method = editingAgent ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agentData)
                });
                
                const result = await response.json();
                if (result.success) {
                    showStatus(`Agent ${editingAgent ? 'updated' : 'created'} successfully!`, 'success');
                    closeModal();
                    await loadTestAgents();
                } else {
                    showStatus(`Error ${editingAgent ? 'updating' : 'creating'} agent`, 'error');
                }
            } catch (error) {
                showStatus(`Error ${editingAgent ? 'updating' : 'creating'} agent`, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
            statusEl.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>${message}`;
            statusEl.classList.remove('hidden');
            
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        // Event listeners
        document.getElementById('addAgentBtn').addEventListener('click', openAddModal);
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        
        document.getElementById('agentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            await saveAgent(formData);
        });

        // Close modal when clicking outside
        document.getElementById('agentModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        // Load agents on page load
        loadTestAgents();
    </script>
</body>
</html>